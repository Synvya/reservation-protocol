{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://schemata.nostr.watch/note/kind/31555",
  "title": "Verified Business Review Event (Kind 31555)",
  "description": "Full event schema for verified business review (kind 31555) - signed public event created by customer to publish a verified review following NIP-99 market specification",
  "allOf": [
    {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "Deterministic event hash as defined in NIP-01",
          "errorMessage": "id must be a 64-character lowercase hex string"
        },
        "content": {
          "type": "string",
          "errorMessage": "content must be a string",
          "description": "The content of the note"
        },
        "created_at": {
          "type": "integer",
          "errorMessage": "created_at must be a timestamp expressed in seconds (not milliseconds)",
          "description": "The timestamp of the note creation"
        },
        "kind": {
          "type": "integer"
        },
        "pubkey": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "errorMessage": "pubkey must be a secp256k1 public key",
          "description": "The public key of the note's author"
        },
        "tags": {
          "type": "array",
          "errorMessage": "tags must be an array of valid tag tuples",
          "description": "The tags of the note",
          "items": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "string"
            }
          }
        },
        "sig": {
          "type": "string",
          "pattern": "^[a-f0-9]{128}$",
          "errorMessage": "sig must be a 128-character lowercase hex string",
          "description": "Signature of the event"
        }
      },
      "required": [
        "content",
        "created_at",
        "kind",
        "tags",
        "sig"
      ],
      "additionalProperties": false
    },
    {
      "type": "object",
      "properties": {
        "kind": {
          "const": 31555,
          "description": "Kind 31555 identifies a verified business review",
          "errorMessage": "kind must equal 31555"
        },
        "id": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "Deterministic event hash as defined in NIP-01",
          "errorMessage": "id must be a 64-character lowercase hex string"
        },
        "pubkey": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "Customer public key",
          "errorMessage": "pubkey must be a 64-character lowercase hex string (secp256k1 public key)"
        },
        "content": {
          "type": "string",
          "minLength": 1,
          "description": "Free-form review text",
          "errorMessage": "content must be a non-empty string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "array",
            "minItems": 1,
            "items": {
              "type": "string"
            }
          },
          "minItems": 4,
          "allOf": [
            {
              "contains": {
                "type": "array",
                "minItems": 2,
                "maxItems": 2,
                "items": [
                  {
                    "const": "d",
                    "description": "Tag identifier"
                  },
                  {
                    "type": "string",
                    "pattern": "^p:[a-f0-9]{64}$",
                    "description": "Business identifier in format p:<businessPublicKey>",
                    "errorMessage": "d tag value must be in format 'p:<64-character-hex-string>'"
                  }
                ],
                "additionalItems": false
              },
              "errorMessage": {
                "contains": "tags must include a d tag with format ['d', 'p:<businessPublicKey>']"
              }
            },
            {
              "contains": {
                "type": "array",
                "minItems": 2,
                "maxItems": 2,
                "items": [
                  {
                    "const": "e",
                    "description": "Tag identifier"
                  },
                  {
                    "type": "string",
                    "pattern": "^[a-f0-9]{64}$",
                    "description": "Unsigned rumor ID of the original reservation.request (kind 9901)",
                    "errorMessage": "e tag value must be a 64-character lowercase hex string (unsigned rumor ID)"
                  }
                ],
                "additionalItems": false
              },
              "errorMessage": {
                "contains": "tags must include an e tag with format ['e', '<unsigned-9901-rumor-id>']"
              }
            },
            {
              "contains": {
                "type": "array",
                "minItems": 2,
                "maxItems": 3,
                "items": [
                  {
                    "const": "rating",
                    "description": "Tag identifier"
                  },
                  {
                    "type": "string",
                    "pattern": "^(0|1)$",
                    "description": "Primary rating: 0 for thumbs down, 1 for thumbs up",
                    "errorMessage": "Primary rating tag value must be '0' or '1'"
                  },
                  {
                    "type": "string",
                    "const": "thumb",
                    "description": "Marker for primary rating"
                  }
                ],
                "additionalItems": false
              },
              "errorMessage": {
                "contains": "tags must include a primary rating tag with format ['rating', '<0 or 1>', 'thumb']"
              }
            },
            {
              "contains": {
                "type": "array",
                "minItems": 2,
                "maxItems": 2,
                "items": [
                  {
                    "const": "verified",
                    "description": "Tag identifier"
                  },
                  {
                    "type": "string",
                    "pattern": "^[A-Za-z0-9+/]+=*$",
                    "description": "Base64 encoded kind:9905 transaction attestation event",
                    "errorMessage": "verified tag value must be a valid base64 encoded string"
                  }
                ],
                "additionalItems": false
              },
              "errorMessage": {
                "contains": "tags must include a verified tag with format ['verified', '<base64-encoded-transaction-attestation-event-kind-9905>']"
              }
            }
          ]
        }
      },
      "required": [
        "kind",
        "id",
        "pubkey",
        "sig"
      ]
    }
  ]
}
